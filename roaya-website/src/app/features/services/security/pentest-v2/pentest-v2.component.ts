import { Component, OnInit, AfterViewInit, OnDestroy, inject, ChangeDetectionStrategy, ChangeDetectorRef, PLATFORM_ID } from '@angular/core';
import { CommonModule, isPlatformBrowser } from '@angular/common';
import { RouterLink } from '@angular/router';
import { TranslateModule } from '@ngx-translate/core';
import { NgIcon, provideIcons } from '@ng-icons/core';
import {
  lucideShield,
  lucideActivity,
  lucideEye,
  lucideZap,
  lucideUsers,
  lucideAward,
  lucideClock,
  lucideTrendingUp,
  lucideBell,
  lucideCheckCircle2,
  lucideDatabase,
  lucideRefreshCw,
  lucideFileText,
  lucideBarChart,
  lucideServer,
  lucideCloud,
  lucideNetwork,
  lucideTarget,
  lucideSearch,
  lucideLock,
  lucideShieldCheck,
  lucideAlertTriangle,
  lucideMail,
  lucideBrain,
  lucideSettings,
  lucideGlobe,
  lucideSmartphone,
  lucideKey,
  lucideMonitor
} from '@ng-icons/lucide';
import { Meta, Title } from '@angular/platform-browser';
import { gsap } from 'gsap';
import { ScrollTrigger } from 'gsap/ScrollTrigger';

/**
 * Penetration Testing V2 Sub-Page
 * Route: /services/security/pentest-v2
 * Parent: Security Service (/services/security)
 * Content: AI-Assisted Enterprise Security Validation
 */
@Component({
  selector: 'app-pentest-v2',
  standalone: true,
  imports: [CommonModule, RouterLink, TranslateModule, NgIcon],
  templateUrl: './pentest-v2.component.html',
  styleUrl: './pentest-v2.component.scss',
  changeDetection: ChangeDetectionStrategy.OnPush,
  providers: [
    provideIcons({
      lucideShield,
      lucideActivity,
      lucideEye,
      lucideZap,
      lucideUsers,
      lucideAward,
      lucideClock,
      lucideTrendingUp,
      lucideBell,
      lucideCheckCircle2,
      lucideDatabase,
      lucideRefreshCw,
      lucideFileText,
      lucideBarChart,
      lucideServer,
      lucideCloud,
      lucideNetwork,
      lucideTarget,
      lucideSearch,
      lucideLock,
      lucideShieldCheck,
      lucideAlertTriangle,
      lucideMail,
      lucideBrain,
      lucideSettings,
      lucideGlobe,
      lucideSmartphone,
      lucideKey,
      lucideMonitor
    })
  ]
})
export class PentestV2Component implements OnInit, AfterViewInit, OnDestroy {
  private readonly platformId = inject(PLATFORM_ID);
  private readonly cdr = inject(ChangeDetectorRef);
  private scrollTriggers: ScrollTrigger[] = [];
  private prefersReducedMotion = false;
  private readonly meta = inject(Meta);
  private readonly title = inject(Title);

  // Environment types for "One Enterprise Service" section
  readonly environmentTypes = [
    { key: 'onPremise', icon: 'lucideServer' },
    { key: 'financial', icon: 'lucideDatabase' },
    { key: 'government', icon: 'lucideShield' },
    { key: 'mobile', icon: 'lucideSmartphone' },
    { key: 'webApis', icon: 'lucideGlobe' },
    { key: 'identity', icon: 'lucideKey' },
    { key: 'remoteWorkforce', icon: 'lucideMonitor' }
  ];

  // What We Provide - 2 service types
  readonly serviceTypes = [
    { id: 'assessment', icon: 'lucideSearch' },
    { id: 'pentest', icon: 'lucideTarget' }
  ];

  // Where AI Adds Value - 6 capabilities
  readonly aiCapabilities = [
    { key: 'correlate', icon: 'lucideNetwork' },
    { key: 'attackPaths', icon: 'lucideTarget' },
    { key: 'reduceNoise', icon: 'lucideBarChart' },
    { key: 'prioritize', icon: 'lucideTrendingUp' },
    { key: 'reporting', icon: 'lucideFileText' },
    { key: 'retesting', icon: 'lucideRefreshCw' }
  ];

  // What Enterprise Leaders Receive - 6 outcomes
  readonly outcomes = [
    { key: 'evidenceBacked', icon: 'lucideCheckCircle2' },
    { key: 'aiPrioritization', icon: 'lucideBrain' },
    { key: 'attackPath', icon: 'lucideNetwork' },
    { key: 'controlValidation', icon: 'lucideShieldCheck' },
    { key: 'executiveReporting', icon: 'lucideFileText' },
    { key: 'postRemediation', icon: 'lucideRefreshCw' }
  ];

  // How We Operate - 4 principles
  readonly operatingPrinciples = [
    { key: 'expertLed', icon: 'lucideUsers' },
    { key: 'riskDriven', icon: 'lucideTarget' },
    { key: 'aiEnhanced', icon: 'lucideBrain' },
    { key: 'frameworkAligned', icon: 'lucideAward' }
  ];

  // Tools used (examples)
  readonly toolsUsed = [
    { key: 'burpSuite' },
    { key: 'tenableQualys' },
    { key: 'nmapMetasploit' },
    { key: 'bloodhound' },
    { key: 'scoutSuite' },
    { key: 'mobileApi' }
  ];

  // Framework Alignment - 4 frameworks
  readonly frameworks = [
    { key: 'nistCsf', icon: 'lucideShieldCheck' },
    { key: 'iso27001', icon: 'lucideAward' },
    { key: 'mitreAttack', icon: 'lucideTarget' },
    { key: 'cisControls', icon: 'lucideCheckCircle2' }
  ];

  // Why Enterprises Choose Us - 6 differentiators
  readonly differentiators = [
    { key: 'aiInsight' },
    { key: 'expertJudgment' },
    { key: 'fullSurface' },
    { key: 'noDependency' },
    { key: 'secureHandling' },
    { key: 'defensibleOutcomes' }
  ];

  // CTA responsibilities
  readonly responsibilities = [
    { key: 'enterprise' },
    { key: 'financial' },
    { key: 'mobile' },
    { key: 'accountability' }
  ];

  ngOnInit(): void {
    // Set page title
    this.title.setTitle('AI-Assisted Penetration Testing & Security Assessment - Roaya IT');

    // Set meta tags for SEO
    this.meta.updateTag({
      name: 'description',
      content: 'AI-assisted, expert-led penetration testing and security assessment services in Egypt. Enterprise security validation with precision, accountability, and defensible results.'
    });

    this.meta.updateTag({
      name: 'keywords',
      content: 'penetration testing Egypt, AI security assessment, enterprise security validation, ethical hacking Egypt, vulnerability assessment, NIST CSF, ISO 27001, MITRE ATT&CK, cybersecurity Egypt'
    });

    // Open Graph tags
    this.meta.updateTag({
      property: 'og:title',
      content: 'AI-Assisted Penetration Testing & Security Assessment - Roaya IT'
    });
    this.meta.updateTag({
      property: 'og:description',
      content: 'Serious organizations validate security with evidence. AI-assisted, expert-led penetration testing designed for organizations that demand precision and defensible results.'
    });
    this.meta.updateTag({ property: 'og:type', content: 'website' });
  }

  ngAfterViewInit(): void {
    if (!isPlatformBrowser(this.platformId)) return;

    // Register GSAP plugins
    gsap.registerPlugin(ScrollTrigger);

    // Check for reduced motion preference
    this.prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Initialize animations
    this.initStaggerAnimations();
  }

  ngOnDestroy(): void {
    // Clean up all ScrollTriggers
    this.scrollTriggers.forEach(trigger => trigger.kill());
    this.scrollTriggers = [];
  }

  /**
   * Initialize stagger reveal animations for sections
   */
  private initStaggerAnimations(): void {
    if (this.prefersReducedMotion) return;

    // Animate environment cards
    const envCards = gsap.utils.toArray('.env-card') as HTMLElement[];
    if (envCards.length > 0) {
      gsap.set(envCards, { opacity: 0, y: 30 });
      const trigger = ScrollTrigger.create({
        trigger: '.environment-section',
        start: 'top 75%',
        onEnter: () => {
          gsap.to(envCards, {
            opacity: 1,
            y: 0,
            duration: 0.6,
            stagger: 0.1,
            ease: 'power3.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate AI capability cards with enhanced Neural Network effect
    const aiCards = gsap.utils.toArray('.ai-node-card') as HTMLElement[];
    if (aiCards.length > 0) {
      gsap.set(aiCards, { opacity: 0, scale: 0.9, y: 30 });
      const trigger = ScrollTrigger.create({
        trigger: '.ai-neural-section',
        start: 'top 70%',
        onEnter: () => {
          gsap.to(aiCards, {
            opacity: 1,
            scale: 1,
            y: 0,
            duration: 0.7,
            stagger: 0.12,
            ease: 'back.out(1.4)'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate SVG connection lines drawing in
    const connectionPaths = gsap.utils.toArray('.connection-lines path') as SVGPathElement[];
    if (connectionPaths.length > 0) {
      // Set initial state - lines fully hidden
      connectionPaths.forEach(path => {
        const length = path.getTotalLength();
        gsap.set(path, { strokeDasharray: length, strokeDashoffset: length });
      });

      const trigger = ScrollTrigger.create({
        trigger: '.ai-neural-section',
        start: 'top 60%',
        onEnter: () => {
          gsap.to(connectionPaths, {
            strokeDashoffset: 0,
            duration: 1.5,
            stagger: 0.1,
            ease: 'power2.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate AI core pulse on scroll
    const aiCore = document.querySelector('.ai-core') as HTMLElement;
    if (aiCore) {
      gsap.set(aiCore, { scale: 0.8, opacity: 0 });
      const trigger = ScrollTrigger.create({
        trigger: '.ai-neural-section',
        start: 'top 80%',
        onEnter: () => {
          gsap.to(aiCore, {
            scale: 1,
            opacity: 0.6,
            duration: 1.2,
            ease: 'power2.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate neural grid fade in
    const neuralGrid = document.querySelector('.neural-grid') as HTMLElement;
    if (neuralGrid) {
      gsap.set(neuralGrid, { opacity: 0 });
      const trigger = ScrollTrigger.create({
        trigger: '.ai-neural-section',
        start: 'top 85%',
        onEnter: () => {
          gsap.to(neuralGrid, {
            opacity: 0.3,
            duration: 1,
            ease: 'power2.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate AI chips fade in with scale effect
    const aiChips = gsap.utils.toArray('.ai-chip-container') as HTMLElement[];
    if (aiChips.length > 0) {
      gsap.set(aiChips, { opacity: 0, scale: 0.8 });
      const trigger = ScrollTrigger.create({
        trigger: '.ai-neural-section',
        start: 'top 75%',
        onEnter: () => {
          gsap.to(aiChips, {
            opacity: (index) => index === 0 ? 0.2 : 0.12, // Primary chip more visible
            scale: 1,
            duration: 1.2,
            stagger: 0.3,
            ease: 'power2.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate outcomes cards
    const outcomes = gsap.utils.toArray('.outcome-card') as HTMLElement[];
    if (outcomes.length > 0) {
      gsap.set(outcomes, { opacity: 0, y: 40 });
      const trigger = ScrollTrigger.create({
        trigger: '.outcomes-section',
        start: 'top 75%',
        onEnter: () => {
          gsap.to(outcomes, {
            opacity: 1,
            y: 0,
            duration: 0.7,
            stagger: 0.15,
            ease: 'power3.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }

    // Animate operating principles
    const principles = gsap.utils.toArray('.principle-card') as HTMLElement[];
    if (principles.length > 0) {
      gsap.set(principles, { opacity: 0, x: -30 });
      const trigger = ScrollTrigger.create({
        trigger: '.operate-section',
        start: 'top 70%',
        onEnter: () => {
          gsap.to(principles, {
            opacity: 1,
            x: 0,
            duration: 0.7,
            stagger: 0.12,
            ease: 'power3.out'
          });
        },
        once: true
      });
      this.scrollTriggers.push(trigger);
    }
  }
}
